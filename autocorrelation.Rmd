---
title: "Spatial Autocorrelation of Enteric Fever and Leptospirosis in Kelantan"
author: "Hazlienor"
date: "2023-04-12"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load library

```{r}
library(sf)
library(tidyverse)
library(here)
library(janitor)
library(gtsummary)
library(DT)
library(stringr)
library(readxl)
library(broom)
library(tmap)
library(mapview)
library(lubridate)
library(maptools)
library(spatstat)
library(spdep)
library(gridExtra)
library(grid)
library(sparr)
library(spatialEco)
```


## Prepare data

read polygon data

```{r}
kel <- st_read(here("Map",
                    "kelantan.shp"))
```


read population data per mukim per year

```{r}
kel_mukim <- read_xlsx(here ("mukim.xlsx"))
```


merge population data to polygon

```{r}
kel_map <- merge(kel,kel_mukim,by.x="MUKIM", by.y="MUKIM", all.x=T, sort=F)
dim(kel_map)
class(kel_map)
st_crs(kel_map)
```


##Spatial autocorrelation using point data

# spatial autocorrelation for enteric fever cases

extract enteric fever 2016-2022

```{r}
#| cache = TRUE
linelist2 <- read_xlsx(here ("linelist.xlsx"))
listENT_kel <- filter(linelist2, Diagnosis=="Enteric_fever")  
listENT_kel16 <- filter(listENT_kel, `Tahun Daftar` =="2016")
listENT_kel17 <- filter(listENT_kel, `Tahun Daftar` =="2017")
listENT_kel18 <- filter(listENT_kel, `Tahun Daftar` =="2018")
listENT_kel19 <- filter(listENT_kel, `Tahun Daftar` =="2019")
listENT_kel20 <- filter(listENT_kel, `Tahun Daftar` =="2020")
listENT_kel21 <- filter(listENT_kel, `Tahun Daftar` =="2021")
listENT_kel22 <- filter(listENT_kel, `Tahun Daftar` =="2022")
```


calculate global moran

```{r}
#| cache = TRUE
# join point to polygon
polyENT_kel <- merge(kel_map, listENT_kel, by = c("MUKIM"))

# count cases in mukim
count_ent <- polyENT_kel%>% 
  count(DAERAH, MUKIM, AVR) %>% 
  ungroup()

# set neigbouring queen
nb_ent <- poly2nb(count_ent, queen = TRUE) 

# identify area with no neighbour
nb_ent[[1]]

# assign weight
lw_ent <- nb2listw(nb_ent, style = "W" , zero.policy = TRUE)

# create lag function
ent_lag <- lag.listw(lw_ent, count_ent$n) 

# calculate global Moran
mt_ent <- moran.test(count_ent$n, lw_ent)

mt_ent
```


calculate local moran

```{r}
#| cache = TRUE
#local moran Enteric fever
Local_Moran_ent <- localmoran(count_ent$n,lw_ent)
ENT_poly <- cbind(count_ent, Local_Moran_ent)
#plot Local Moran
ggplot(data = ENT_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I statistic for Enteric Fever 2016-2022",
       subtitle="Kelantan")
```


Moran's I by year

```{r}
#| cache = TRUE
#Morans I by year 
#2016
polyENT_kel16 <- merge(kel_map, listENT_kel16, by = c("MUKIM"))
count_ent16 <- polyENT_kel16%>% 
  count(MUKIM, AVR, JUMLAH_2016) %>% 
  ungroup()
count_ent16s <-count_ent16[-13, ] #remove region with no link from polygon
nb_ent16 <- poly2nb(count_ent16, queen = TRUE) #set neigbouring queen
nb_ent16 # identify region with no link
nb_ent16s <-subset(nb_ent16, subset=card(nb_ent16) > 0) #remove region with no link
lw_ent16 <- nb2listw(nb_ent16s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag16 <- lag.listw(lw_ent16, count_ent16s$n) #create lag function
gmoran16 <- moran.test(count_ent16s$n, lw_ent16, randomisation=TRUE, zero.policy=NULL,
                       alternative="greater", rank = FALSE, na.action=na.fail, spChk=NULL,
                       adjust.n=TRUE, drop.EI2=FALSE)
gmoran16

#local moran Enteric fever
Local_Moran_ent16 <- localmoran(count_ent16s$n,lw_ent16)
ENT_poly16 <- cbind(count_ent16s, Local_Moran_ent16)
#plot Local Moran
ggplot(data = ENT_poly16) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2016",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#Moran 2017
polyENT_kel17 <- merge(kel_map, listENT_kel17, by = c("MUKIM"))
count_ent17 <- polyENT_kel17%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2017) %>% 
  ungroup()
nb_ent17 <- poly2nb(count_ent17, queen = TRUE) #set neigbouring queen
nb_ent17 # identify region with no
nb_ent17s <-subset(nb_ent17, subset=card(nb_ent17) > 0)
nb_ent17s
count_ent17s <- count_ent17[-c(5,6,14,15,16,17,18),]
count_ent17s
lw_ent17 <- nb2listw(nb_ent17s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag17 <- lag.listw(lw_ent17, count_ent17s$n) #create lag function
gmoran17 <- moran.test(count_ent17s$n, lw_ent17)
gmoran17

#local moran Enteric fever
Local_Moran_ent17 <- localmoran(count_ent17s$n,lw_ent17)
ENT_poly17 <- cbind(count_ent17s, Local_Moran_ent17)
#plot Local Moran
ggplot(data = ENT_poly17) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2017",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#Moran 2018
polyENT_kel18 <- merge(kel_map, listENT_kel18, by = c("MUKIM"))
count_ent18 <- polyENT_kel18%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2018) %>% 
  ungroup()
nb_ent18 <- poly2nb(count_ent18, queen = TRUE) #set neigbouring queen
nb_ent18 #identify region with no link
nb_ent18s <-subset(nb_ent18, subset=card(nb_ent18) > 0)
count_ent18s <-count_ent18[-c(1,4,18),]
lw_ent18 <- nb2listw(nb_ent18s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag18 <- lag.listw(lw_ent18, count_ent18s$n) #create lag function
gmoran18 <- moran.test(count_ent18s$n, lw_ent18)
gmoran18

#local moran Enteric fever
Local_Moran_ent18 <- localmoran(count_ent18s$n,lw_ent18)
ENT_poly18 <- cbind(count_ent18s, Local_Moran_ent18)
#plot Local Moran
ggplot(data = ENT_poly18) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2018",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#Moran 2019
polyENT_kel19 <- merge(kel_map, listENT_kel19, by = c("MUKIM"))
count_ent19 <- polyENT_kel19%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2019) %>% 
  ungroup()
nb_ent19 <- poly2nb(count_ent19, queen = TRUE) #set neigbouring queen
nb_ent19
nb_ent19s <-subset(nb_ent19, subset=card(nb_ent19) > 0)
count_ent19s <-count_ent19[-c(4,9,10,11,12),]
lw_ent19 <- nb2listw(nb_ent19s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag19 <- lag.listw(lw_ent19, count_ent19s$n) #create lag function
gmoran19 <- moran.test(count_ent19s$n, lw_ent19)
gmoran19

#local moran Enteric fever
Local_Moran_ent19 <- localmoran(count_ent19s$n,lw_ent19)
ENT_poly19 <- cbind(count_ent19s, Local_Moran_ent19)
#plot Local Moran
ggplot(data = ENT_poly19) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2019",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#Moran 2020
polyENT_kel20 <- merge(kel_map, listENT_kel20, by = c("MUKIM"))
count_ent20 <- polyENT_kel20%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2020) %>% 
  ungroup()
nb_ent20 <- poly2nb(count_ent20, queen = TRUE) #set neigbouring queen
nb_ent20 #identify region with no link
nb_ent20s <-subset(nb_ent20, subset=card(nb_ent20) > 0)
count_ent20s <-count_ent20[-c(3,9),]
lw_ent20 <- nb2listw(nb_ent20s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag20 <- lag.listw(lw_ent20, count_ent20s$n) #create lag function
gmoran20 <-moran.test(count_ent20s$n, lw_ent20)
gmoran20

#local moran Enteric fever
Local_Moran_ent20 <- localmoran(count_ent20s$n,lw_ent20)
ENT_poly20 <- cbind(count_ent20s, Local_Moran_ent20)
#plot Local Moran
ggplot(data = ENT_poly20) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2020",
       subtitle="Kelantan")
```

```{r}
# Moran 21
polyENT_kel21 <- merge(kel_map, listENT_kel21, by = c("MUKIM"))
count_ent21 <- polyENT_kel21%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2021) %>% 
  ungroup()
nb_ent21 <- poly2nb(count_ent21, queen = TRUE) #set neigbouring queen
nb_ent21
nb_ent21s <-subset(nb_ent21, subset=card(nb_ent21) > 0)
count_ent21s <-count_ent21[-c(3),]
lw_ent21 <- nb2listw(nb_ent21s, style = "W" , zero.policy = TRUE) #assign weight
```



```{r, eval=FALSE}
#| cache = TRUE
# Moran 21
polyENT_kel21 <- merge(kel_map, listENT_kel21, by = c("MUKIM"))
count_ent21 <- polyENT_kel21%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2021) %>% 
  ungroup()
nb_ent21 <- poly2nb(count_ent21, queen = TRUE) #set neigbouring queen
nb_ent21
nb_ent21s <-subset(nb_ent21, subset=card(nb_ent21) > 0)
count_ent21s <-count_ent21[-c(3),]
lw_ent21 <- nb2listw(nb_ent21s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag21 <- lag.listw(lw_ent21, count_ent21s$n) #create lag function

# check for missing value
any(is.na(lw_ent21$weights))
any(is.na(count_ent21s$n))

# Apply the arcsine transformation to the count data
count_arcsin <- asin(sqrt(count_ent21s$n / (max(count_ent21s$n) + 1)))



# Run the Moran's I test
gmoran21 <- moran.test(count_arcsin, lw_ent21, zero.policy=TRUE)

# already tried sqrt and log transformation, unsuccessful

# local moran Enteric fever
Local_Moran_ent21 <- localmoran(count_ent21s$n,lw_ent21)
ENT_poly21 <- cbind(count_ent21s, Local_Moran_ent21)

# plot Local Moran
ggplot(data = ENT_poly21) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2021",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#Moran 2022
polyENT_kel22 <- merge(kel_map, listENT_kel22, by = c("MUKIM"))
count_ent22 <- polyENT_kel22%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2022) %>% 
  ungroup()
nb_ent22 <- poly2nb(count_ent22, queen = TRUE) #set neigbouring queen
nb_ent22
nb_ent22s <-subset(nb_ent22, subset=card(nb_ent22) > 0)
count_ent22s <-count_ent22[-c(1,3,8,10),]
lw_ent22 <- nb2listw(nb_ent22s, style = "W" , zero.policy = TRUE) #assign weight
ent_lag22 <- lag.listw(lw_ent22, count_ent22s$n) #create lag function
gmoran22 <- moran.test(count_ent22s$n, lw_ent22)
gmoran22


#local moran Enteric fever
Local_Moran_ent22 <- localmoran(count_ent22s$n,lw_ent22)
ENT_poly22 <- cbind(count_ent22s, Local_Moran_ent22)
#plot Local Moran
ggplot(data = ENT_poly22) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I Statistic for Enteric Fever Cases in 2022",
       subtitle="Kelantan")
```


# spatial autocorrelation for leptospirosis cases

prepare linelisting

```{r}
#| cache = TRUE
#extract leptospirosis 2016-2022
linelist2 <- read_xlsx(here ("linelist.xlsx"))
listLEP_kel <- filter(linelist2, Diagnosis=="Leptospirosis")
LEP_kel16 <- filter(linelist2, `Tahun Daftar` =="2016")
LEP_kel17 <- filter(linelist2, `Tahun Daftar` =="2017")
LEP_kel18 <- filter(linelist2, `Tahun Daftar` =="2018")
LEP_kel19 <- filter(linelist2, `Tahun Daftar` =="2019")
LEP_kel20 <- filter(linelist2, `Tahun Daftar` =="2020")
LEP_kel21 <- filter(linelist2, `Tahun Daftar` =="2021")
LEP_kel22 <- filter(linelist2, `Tahun Daftar` =="2022")
```


Global Moran

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2016-2022
polyLEP_kel <- merge(kel_map, listLEP_kel, by = c("MUKIM"))
count_lep <- polyLEP_kel%>% 
  count(DAERAH, MUKIM, AVR) %>% 
  ungroup()
nb_lep <- poly2nb(count_lep, queen = TRUE) #set neigbouring queen
nb_lep[[1]]
lw_lep <- nb2listw(nb_lep, style = "W" , zero.policy = TRUE) #assign weight
lep_lag <- lag.listw(lw_lep, count_lep$n) #create lag function
moran.test(count_lep$n, lw_lep)

```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2016
polyLEP_kel16 <- merge(kel_map, LEP_kel16, by = c("MUKIM"))
count_lep16 <- polyLEP_kel16%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2016) %>% 
  ungroup()
nb_lep16 <- poly2nb(count_lep16, queen = TRUE) #set neigbouring queen
nb_lep16[[1]]
lw_lep16 <- nb2listw(nb_lep16, style = "W" , zero.policy = TRUE) #assign weight
lep16_lag <- lag.listw(lw_lep16, count_lep16$n) #create lag function
moran.test(count_lep16$n, lw_lep16)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2017
polyLEP_kel17 <- merge(kel_map, LEP_kel17, by = c("MUKIM"))
count_lep17 <- polyLEP_kel17%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2017) %>% 
  ungroup()
nb_lep17 <- poly2nb(count_lep17, queen = TRUE) #set neigbouring queen
nb_lep17[[1]]
lw_lep17 <- nb2listw(nb_lep17, style = "W" , zero.policy = TRUE) #assign weight
lep17_lag <- lag.listw(lw_lep17, count_lep17$n) #create lag function
moran.test(count_lep17$n, lw_lep17)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2018
polyLEP_kel18 <- merge(kel_map, LEP_kel18, by = c("MUKIM"))
count_lep18 <- polyLEP_kel18%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2018) %>% 
  ungroup()
nb_lep18 <- poly2nb(count_lep18, queen = TRUE) #set neigbouring queen
nb_lep18[[1]]
lw_lep18 <- nb2listw(nb_lep18, style = "W" , zero.policy = TRUE) #assign weight
lep18_lag <- lag.listw(lw_lep18, count_lep18$n) #create lag function
moran.test(count_lep18$n, lw_lep18)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2019
polyLEP_kel19 <- merge(kel_map, LEP_kel19, by = c("MUKIM"))
count_lep19 <- polyLEP_kel19%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2019) %>% 
  ungroup()
nb_lep19 <- poly2nb(count_lep19, queen = TRUE) #set neigbouring queen
nb_lep19[[1]]
lw_lep19 <- nb2listw(nb_lep19, style = "W" , zero.policy = TRUE) #assign weight
lep19_lag <- lag.listw(lw_lep19, count_lep19$n) #create lag function
moran.test(count_lep19$n, lw_lep19)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2020
polyLEP_kel20 <- merge(kel_map, LEP_kel20, by = c("MUKIM"))
count_lep20 <- polyLEP_kel20%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2020) %>% 
  ungroup()
nb_lep20 <- poly2nb(count_lep20, queen = TRUE) #set neigbouring queen
nb_lep20[[1]]
lw_lep20 <- nb2listw(nb_lep20, style = "W" , zero.policy = TRUE) #assign weight
lep20_lag <- lag.listw(lw_lep20, count_lep20$n) #create lag function
moran.test(count_lep20$n, lw_lep20)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2021
polyLEP_kel21 <- merge(kel_map, LEP_kel21, by = c("MUKIM"))
count_lep21 <- polyLEP_kel21%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2021) %>% 
  ungroup()
nb_lep21 <- poly2nb(count_lep21, queen = TRUE) #set neigbouring queen
nb_lep21[[1]]
lw_lep21 <- nb2listw(nb_lep21, style = "W" , zero.policy = TRUE) #assign weight
lep21_lag <- lag.listw(lw_lep21, count_lep21$n) #create lag function
moran.test(count_lep21$n, lw_lep21)
```

```{r}
#| cache = TRUE
#Moran's I for leptospirosis 2022
polyLEP_kel22 <- merge(kel_map, LEP_kel22, by = c("MUKIM"))
count_lep22 <- polyLEP_kel22%>% 
  count(DAERAH, MUKIM, AVR, JUMLAH_2022) %>% 
  ungroup()
nb_lep22 <- poly2nb(count_lep22, queen = TRUE) #set neigbouring queen
nb_lep22[[1]]
lw_lep22 <- nb2listw(nb_lep22, style = "W" , zero.policy = TRUE) #assign weight
lep22_lag <- lag.listw(lw_lep22, count_lep22$n) #create lag function
moran.test(count_lep22$n, lw_lep22)
```

Local Moran

```{r}
#| cache = TRUE
#local moran leptospirosis 2016-2022
Local_Moran_lep <- localmoran(count_lep$n,lw_lep)
LEP_poly <- cbind(count_lep, Local_Moran_lep)
#plot Local Moran
ggplot(data = LEP_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="Local Moran's I statistic for Leptospirosis 2016-2022",
       subtitle="Kelantan")
```


```{r}
#| cache = TRUE
#2016
Local_Moran_lep16 <- localmoran(count_lep16$n,lw_lep16)
LEP16_poly <- cbind(count_lep16, Local_Moran_lep16)
#plot Local Moran
plotMlep16 <- ggplot(data = LEP16_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2016")

#2017
Local_Moran_lep17 <- localmoran(count_lep17$n,lw_lep17)
LEP17_poly <- cbind(count_lep17, Local_Moran_lep17)
#plot Local Moran
plotMlep17 <- ggplot(data = LEP17_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2017")

#2018
Local_Moran_lep18 <- localmoran(count_lep18$n,lw_lep18)
LEP18_poly <- cbind(count_lep18, Local_Moran_lep18)
#plot Local Moran
plotMlep18 <- ggplot(data = LEP18_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2018")

#2019
Local_Moran_lep19 <- localmoran(count_lep19$n,lw_lep19)
LEP19_poly <- cbind(count_lep19, Local_Moran_lep19)
#plot Local Moran
plotMlep19 <-ggplot(data = LEP19_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2019")

#2020 - Global Moran's not significant
#2021 - Global Moran's not significant

#2022
Local_Moran_lep22 <- localmoran(count_lep22$n,lw_lep22)
LEP22_poly <- cbind(count_lep22, Local_Moran_lep22)
#plot Local Moran
plotMlep22 <-ggplot(data = LEP22_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2022")

#2016-2022
plotMlep <-ggplot(data = LEP_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2016-2022")
```


local Moran's I p-values map for leptospirosis

```{r}
#| cache = TRUE
LMp16 <- tm_shape(LEP16_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2016")+
  tm_borders(alpha = 0.5)

LMp17 <- tm_shape(LEP17_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2017")+
  tm_borders(alpha = 0.5)

LMp18 <- tm_shape(LEP18_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2018")+
  tm_borders(alpha = 0.5)

LMp19 <- tm_shape(LEP19_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2019")+
  tm_borders(alpha = 0.5)

LMp22 <- tm_shape(LEP22_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2022")+
  tm_borders(alpha = 0.5)

LMp <- tm_shape(LEP_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Purples",
          title = "2016-2022")+
  tm_borders(alpha = 0.5)
```


combine all local moran plot for leptospirosis  in one view

```{r name-of-chunk26, fig.width=14, fig.height=9}
#| cache = TRUE
grid.arrange(plotMlep16, plotMlep17, plotMlep18, plotMlep19, plotMlep22,plotMlep, nrow=2, top=textGrob("Local Moran's I Map of Leptospirosis in Kelantan 2016-2022", gp = gpar(fontsize = 20)))
```


combine all local moran pvalue plot for leptospirosis  in one view

```{r name-of-chunk27, fig.width=16, fig.height=9}
#| cache = TRUE
tmap_arrange(LMp16, LMp17, LMp18, LMp19, LMp22, LMp, ncol = 3) 
```


LISA map for Leptospirosis

```{r}
#| cache = TRUE
#LISA 2016-2022
m_lep <- count_lep$n - mean(count_lep$n) #Center the variable of interest around its mean
m_local_lep <- Local_Moran_lep[,1]- mean(Local_Moran_lep[,1]) #Center the local Moran around the mean
signif <- 0.05 #significant threshold
quadrant_lep <- vector(mode="numeric",length = nrow(Local_Moran_lep))
#set classification - built data quadrant
quadrant_lep [m_lep>0 & m_local_lep>0] <- 4
quadrant_lep [m_lep<0 & m_local_lep<0] <- 1
quadrant_lep [m_lep<0 & m_local_lep>0] <- 2
quadrant_lep [m_lep>0 & m_local_lep<0] <- 3
quadrant_lep [Local_Moran_lep[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep[,5],main = "2016-2022", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#2016
m_lep16 <- count_lep16$n - mean(count_lep16$n) 
m_local_lep16 <- Local_Moran_lep16[,1]- mean(Local_Moran_lep16[,1]) 
signif <- 0.05 #significant threshold
quadrant_lep16 <- vector(mode="numeric",length = nrow(Local_Moran_lep16))
quadrant_lep16 [m_lep16>0 & m_local_lep16>0] <- 4
quadrant_lep16 [m_lep16<0 & m_local_lep16<0] <- 1
quadrant_lep16 [m_lep16<0 & m_local_lep16>0] <- 2
quadrant_lep16 [m_lep16>0 & m_local_lep16<0] <- 3
quadrant_lep16 [Local_Moran_lep16[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep16[,5],main = "2016", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep16,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#2017
m_lep17 <- count_lep17$n - mean(count_lep17$n) 
m_local_lep17 <- Local_Moran_lep16[,1]- mean(Local_Moran_lep17[,1]) 
signif <- 0.05
quadrant_lep17 <- vector(mode="numeric",length = nrow(Local_Moran_lep17))
quadrant_lep17 [m_lep17>0 & m_local_lep17>0] <- 4
quadrant_lep17 [m_lep17<0 & m_local_lep17<0] <- 1
quadrant_lep17 [m_lep17<0 & m_local_lep17>0] <- 2
quadrant_lep17 [m_lep17>0 & m_local_lep17<0] <- 3
quadrant_lep17 [Local_Moran_lep17[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep17[,5],main = "2017", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep17,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#2018
m_lep18 <- count_lep18$n - mean(count_lep18$n) 
m_local_lep18 <- Local_Moran_lep18[,1]- mean(Local_Moran_lep18[,1]) 
signif <- 0.05
quadrant_lep18 <- vector(mode="numeric",length = nrow(Local_Moran_lep17))
quadrant_lep18 [m_lep18>0 & m_local_lep18>0] <- 4
quadrant_lep18 [m_lep18<0 & m_local_lep18<0] <- 1
quadrant_lep18 [m_lep18<0 & m_local_lep18>0] <- 2
quadrant_lep18 [m_lep18>0 & m_local_lep18<0] <- 3
quadrant_lep18 [Local_Moran_lep18[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep18[,5],main = "2018", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep18,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#2019
m_lep19 <- count_lep19$n - mean(count_lep19$n) 
m_local_lep19 <- Local_Moran_lep19[,1]- mean(Local_Moran_lep19[,1]) 
signif <- 0.05
quadrant_lep19 <- vector(mode="numeric",length = nrow(Local_Moran_lep17))
quadrant_lep19 [m_lep19>0 & m_local_lep19>0] <- 4
quadrant_lep19 [m_lep19<0 & m_local_lep19<0] <- 1
quadrant_lep19 [m_lep19<0 & m_local_lep19>0] <- 2
quadrant_lep19 [m_lep19>0 & m_local_lep19<0] <- 3
quadrant_lep19 [Local_Moran_lep19[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep19[,5],main = "2019", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep19,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#2022
m_lep22 <- count_lep22$n - mean(count_lep22$n) 
m_local_lep22 <- Local_Moran_lep22[,1]- mean(Local_Moran_lep22[,1]) 
signif <- 0.05
quadrant_lep22 <- vector(mode="numeric",length = nrow(Local_Moran_lep17))
quadrant_lep22 [m_lep19>0 & m_local_lep22>0] <- 4
quadrant_lep22 [m_lep19<0 & m_local_lep22<0] <- 1
quadrant_lep22 [m_lep19<0 & m_local_lep22>0] <- 2
quadrant_lep22 [m_lep19>0 & m_local_lep22<0] <- 3
quadrant_lep22 [Local_Moran_lep22[,5]] <- 0

#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(count_lep22[,5],main = "2022", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep22,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")
```

calculate Getis ord i* statistic for leptospirosis cases

```{r}
#| cache = TRUE
#2016
getis_ordlep16 <- localG(count_lep16$n, lw_lep16)

# join results to sf data
count_lep16$getis_ord <- getis_ordlep16

# plot map
GiLEP16 <- ggplot(data=count_lep16) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2016")

#2017
getis_ordlep17 <- localG(count_lep17$n, lw_lep17)
count_lep17$getis_ord <- getis_ordlep17
GiLEP17 <- ggplot(data=count_lep17) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2017")

#2018
getis_ordlep18 <- localG(count_lep18$n, lw_lep18)
count_lep18$getis_ord <- getis_ordlep18
GiLEP18 <- ggplot(data=count_lep18) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2018")

#2019
getis_ordlep19 <- localG(count_lep19$n, lw_lep19)
count_lep19$getis_ord <- getis_ordlep19
GiLEP19 <- ggplot(data=count_lep19) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2019")

#2020
getis_ordlep20 <- localG(count_lep20$n, lw_lep20)
count_lep20$getis_ord <- getis_ordlep20
GiLEP20 <- ggplot(data=count_lep20) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2020")

#2021
getis_ordlep21 <- localG(count_lep21$n, lw_lep21)
count_lep21$getis_ord <- getis_ordlep21
GiLEP21 <- ggplot(data=count_lep21) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2021")

#2022
getis_ordlep22 <- localG(count_lep22$n, lw_lep22)
count_lep22$getis_ord <- getis_ordlep22
GiLEP22 <- ggplot(data=count_lep22) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2022")

#2016-2022
getis_ordlep <- localG(count_lep$n, lw_lep)
count_lep$getis_ord <- getis_ordlep
GiLEP <- ggplot(data=count_lep) +
  geom_sf(aes(fill=getis_ord)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Gi*") +
  labs(title="2016-2022")
```


plot Getis ord Map for leptospirosis

```{r name-of-chunk28, fig.width=16, fig.height=9}
#| cache = TRUE
grid.arrange(GiLEP16, GiLEP17, GiLEP18, GiLEP19, GiLEP20, GiLEP21, GiLEP22, GiLEP, nrow=2, top=textGrob("Getis Ord Gi* Statistic Map of Leptospirosis Cases in Kelantan 2016-2022", gp = gpar(fontsize = 20)))
```

## Spatial autocorrelation using incidence data

# enteric fever incidence 

Global Moran for enteric fever incidence 

```{r}
#| cache = TRUE
# 2016
inc_ent_kel16 <- count_ent16 %>% 
  mutate(inc_1000 = (n/JUMLAH_2016)*1000)
nb_ent_inc16 <- poly2nb(inc_ent_kel16, queen = TRUE) #set neigbouring queen
nb_ent_inc16 
nb_ent_inc16s <-subset(nb_ent_inc16, subset=card(nb_ent_inc16) > 0)
inc_ent_kel16s <-inc_ent_kel16[-c(13),]
lw_ent_inc16 <- nb2listw(nb_ent_inc16s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag16 <- lag.listw(lw_ent_inc16, inc_ent_kel16s$inc_1000) #create lag function
moran.test(inc_ent_kel16s$inc_1000, lw_ent_inc16)

# 2017
inc_ent_kel17 <- count_ent17 %>% 
  mutate(inc_1000 = (n/JUMLAH_2017)*1000)
nb_ent_inc17 <- poly2nb(inc_ent_kel17, queen = TRUE) #set neigbouring queen
nb_ent_inc17 
nb_ent_inc17s <-subset(nb_ent_inc17, subset=card(nb_ent_inc17) > 0)
inc_ent_kel17s <-inc_ent_kel17[-c(5, 6, 14, 15, 16, 17, 18),]
lw_ent_inc17 <- nb2listw(nb_ent_inc17s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag17 <- lag.listw(lw_ent_inc17, inc_ent_kel17s$inc_1000) #create lag function
moran.test(inc_ent_kel17s$inc_1000, lw_ent_inc17)

# 2018
inc_ent_kel18 <- count_ent18 %>% 
  mutate(inc_1000 = (n/JUMLAH_2018)*1000)
nb_ent_inc18 <- poly2nb(inc_ent_kel18, queen = TRUE) #set neigbouring queen
nb_ent_inc18 
nb_ent_inc18s <-subset(nb_ent_inc18, subset=card(nb_ent_inc18) > 0)
inc_ent_kel18s <-inc_ent_kel18[-c(1, 4, 18),]
lw_ent_inc18 <- nb2listw(nb_ent_inc18s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag18 <- lag.listw(lw_ent_inc18, inc_ent_kel18s$inc_1000) #create lag function
moran.test(inc_ent_kel18s$inc_1000, lw_ent_inc18)

# 2019
inc_ent_kel19 <- count_ent19 %>% 
  mutate(inc_1000 = (n/JUMLAH_2019)*1000)
nb_ent_inc19 <- poly2nb(inc_ent_kel19, queen = TRUE) #set neigbouring queen
nb_ent_inc19 
nb_ent_inc19s <-subset(nb_ent_inc19, subset=card(nb_ent_inc19) > 0)
inc_ent_kel19s <-inc_ent_kel19[-c(4, 9, 10, 11, 12),]
lw_ent_inc19 <- nb2listw(nb_ent_inc19s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag19 <- lag.listw(lw_ent_inc19, inc_ent_kel19s$inc_1000) #create lag function
moran.test(inc_ent_kel19s$inc_1000, lw_ent_inc19)

# 2020
inc_ent_kel20 <- count_ent20 %>% 
  mutate(inc_1000 = (n/JUMLAH_2020)*1000)
nb_ent_inc20 <- poly2nb(inc_ent_kel20, queen = TRUE) #set neigbouring queen
nb_ent_inc20 
nb_ent_inc20s <-subset(nb_ent_inc20, subset=card(nb_ent_inc20) > 0)
inc_ent_kel20s <-inc_ent_kel20[-c(3, 9),]
lw_ent_inc20 <- nb2listw(nb_ent_inc20s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag20 <- lag.listw(lw_ent_inc20, inc_ent_kel20s$inc_1000) #create lag function
moran.test(inc_ent_kel20s$inc_1000, lw_ent_inc20)

# 2021
inc_ent_kel21 <- count_ent21 %>% 
  mutate(inc_1000 = (n/JUMLAH_2021)*1000)
nb_ent_inc21 <- poly2nb(inc_ent_kel21, queen = TRUE) #set neigbouring queen
nb_ent_inc21 
nb_ent_inc21s <-subset(nb_ent_inc21, subset=card(nb_ent_inc21) > 0)
inc_ent_kel21s <-inc_ent_kel21[-c(3),]
lw_ent_inc21 <- nb2listw(nb_ent_inc21s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag21 <- lag.listw(lw_ent_inc21, inc_ent_kel21s$inc_1000) #create lag function
moran.test(inc_ent_kel21s$inc_1000, lw_ent_inc21)

# 2022
inc_ent_kel22 <- count_ent22 %>% 
  mutate(inc_1000 = (n/JUMLAH_2022)*1000)
nb_ent_inc22 <- poly2nb(inc_ent_kel22, queen = TRUE) #set neigbouring queen
nb_ent_inc22 
nb_ent_inc22s <-subset(nb_ent_inc22, subset=card(nb_ent_inc22) > 0)
inc_ent_kel22s <-inc_ent_kel22[-c(1, 3, 8, 10),]
lw_ent_inc22 <- nb2listw(nb_ent_inc22s, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag22 <- lag.listw(lw_ent_inc22, inc_ent_kel22s$inc_1000) #create lag function
moran.test(inc_ent_kel22s$inc_1000, lw_ent_inc22)

# 2016-2022
inc_ent_kel <- count_ent %>% 
  mutate(inc_1000 = (n/AVR)*1000)
nb_ent_inc <- poly2nb(inc_ent_kel, queen = TRUE) #set neigbouring queen
lw_ent_inc <- nb2listw(nb_ent_inc, style = "W" , zero.policy = TRUE) #assign weight
lep_ent_lag <- lag.listw(lw_ent_inc, inc_ent_kel$inc_1000) #create lag function
moran.test(inc_ent_kel$inc_1000, lw_ent_inc)
```


# Leptospirosis incidence 

Global Moran for leptospirosis incidence 

```{r}
#| cache = TRUE
# 2016
inc_lep_kel16 <- count_lep16 %>% 
  mutate(inc_1000 = (n/JUMLAH_2016)*1000)
nb_lep_inc16 <- poly2nb(inc_lep_kel16, queen = TRUE) #set neigbouring queen
lw_lep_inc16 <- nb2listw(nb_lep_inc16, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag16 <- lag.listw(lw_lep_inc16, inc_lep_kel16$inc_1000) #create lag function
moran.test(inc_lep_kel16$inc_1000, lw_lep_inc16)

# 2017
inc_lep_kel17 <- count_lep17 %>% 
  mutate(inc_1000 = (n/JUMLAH_2017)*1000)
nb_lep_inc17 <- poly2nb(inc_lep_kel17, queen = TRUE) #set neigbouring queen
lw_lep_inc17 <- nb2listw(nb_lep_inc17, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag17 <- lag.listw(lw_lep_inc17, inc_lep_kel17$inc_1000) #create lag function
moran.test(inc_lep_kel17$inc_1000, lw_lep_inc17)

# 2018
inc_lep_kel18 <- count_lep18 %>% 
  mutate(inc_1000 = (n/JUMLAH_2018)*1000)
nb_lep_inc18 <- poly2nb(inc_lep_kel18, queen = TRUE) #set neigbouring queen
lw_lep_inc18 <- nb2listw(nb_lep_inc18, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag18 <- lag.listw(lw_lep_inc18, inc_lep_kel18$inc_1000) #create lag function
moran.test(inc_lep_kel18$inc_1000, lw_lep_inc18)

# 2019
inc_lep_kel19 <- count_lep19 %>% 
  mutate(inc_1000 = (n/JUMLAH_2019)*1000)
nb_lep_inc19 <- poly2nb(inc_lep_kel19, queen = TRUE) #set neigbouring queen
lw_lep_inc19 <- nb2listw(nb_lep_inc19, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag19 <- lag.listw(lw_lep_inc19, inc_lep_kel19$inc_1000) #create lag function
moran.test(inc_lep_kel19$inc_1000, lw_lep_inc19)

# 2020
inc_lep_kel20 <- count_lep20 %>% 
  mutate(inc_1000 = (n/JUMLAH_2020)*1000)
nb_lep_inc20 <- poly2nb(inc_lep_kel20, queen = TRUE) #set neigbouring queen
lw_lep_inc20 <- nb2listw(nb_lep_inc20, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag20 <- lag.listw(lw_lep_inc20, inc_lep_kel20$inc_1000) #create lag function
moran.test(inc_lep_kel20$inc_1000, lw_lep_inc20)

# 2021
inc_lep_kel21 <- count_lep21 %>% 
  mutate(inc_1000 = (n/JUMLAH_2021)*1000)
nb_lep_inc21 <- poly2nb(inc_lep_kel21, queen = TRUE) #set neigbouring queen
lw_lep_inc21 <- nb2listw(nb_lep_inc21, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag21 <- lag.listw(lw_lep_inc21, inc_lep_kel21$inc_1000) #create lag function
moran.test(inc_lep_kel21$inc_1000, lw_lep_inc21)

# 2022
inc_lep_kel22 <- count_lep22 %>% 
  mutate(inc_1000 = (n/JUMLAH_2022)*1000)
nb_lep_inc22 <- poly2nb(inc_lep_kel22, queen = TRUE) #set neigbouring queen
lw_lep_inc22 <- nb2listw(nb_lep_inc22, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag22 <- lag.listw(lw_lep_inc22, inc_lep_kel22$inc_1000) #create lag function
moran.test(inc_lep_kel22$inc_1000, lw_lep_inc22)

# 2016-2022
inc_lep_kel <- count_lep %>% 
  mutate(inc_1000 = (n/AVR)*1000)
nb_lep_inc <- poly2nb(inc_lep_kel, queen = TRUE) #set neigbouring queen
lw_lep_inc <- nb2listw(nb_lep_inc, style = "W" , zero.policy = TRUE) #assign weight
lep_inc_lag <- lag.listw(lw_lep_inc, inc_lep_kel$inc_1000) #create lag function
moran.test(inc_lep_kel$inc_1000, lw_lep_inc)
```


local Moran for Leptospirosis incidence

```{r}
#| cache = TRUE
#2016
Local_Moran_lep16inc <- localmoran(inc_lep_kel16$inc_1000,lw_lep_inc16)
LEP16inc_poly <- cbind(inc_lep_kel16, Local_Moran_lep16inc)
#plot Local Moran
plotMlep16inc <- ggplot(data = LEP16inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2016")
plot(plotMlep16inc) 

#2017
Local_Moran_lep17inc <- localmoran(inc_lep_kel17$inc_1000,lw_lep_inc17)
LEP17inc_poly <- cbind(inc_lep_kel17, Local_Moran_lep17inc)
#plot Local Moran
plotMlep17inc <- ggplot(data = LEP17inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2017")
plot(plotMlep17inc) 

#2018
Local_Moran_lep18inc <- localmoran(inc_lep_kel18$inc_1000,lw_lep_inc18)
LEP18inc_poly <- cbind(inc_lep_kel18, Local_Moran_lep18inc)
#plot Local Moran
plotMlep18inc <- ggplot(data = LEP18inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2018")
plot(plotMlep18inc) 

#2019
Local_Moran_lep19inc <- localmoran(inc_lep_kel19$inc_1000,lw_lep_inc19)
LEP19inc_poly <- cbind(inc_lep_kel19, Local_Moran_lep19inc)
#plot Local Moran
plotMlep19inc <- ggplot(data = LEP19inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2019")
plot(plotMlep19inc)

#2020
Local_Moran_lep20inc <- localmoran(inc_lep_kel20$inc_1000,lw_lep_inc20)
LEP20inc_poly <- cbind(inc_lep_kel20, Local_Moran_lep20inc)
#plot Local Moran
plotMlep20inc <- ggplot(data = LEP20inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2020")
plot(plotMlep20inc)

#2021
Local_Moran_lep21inc <- localmoran(inc_lep_kel21$inc_1000,lw_lep_inc21)
LEP21inc_poly <- cbind(inc_lep_kel21, Local_Moran_lep21inc)
#plot Local Moran
plotMlep21inc <- ggplot(data = LEP21inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2021")
plot(plotMlep21inc)

#2022
Local_Moran_lep22inc <- localmoran(inc_lep_kel22$inc_1000,lw_lep_inc22)
LEP22inc_poly <- cbind(inc_lep_kel22, Local_Moran_lep22inc)
#plot Local Moran
plotMlep22inc <- ggplot(data = LEP22inc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2022")
plot(plotMlep22inc)

#2016-2022
Local_Moran_lepinc <- localmoran(inc_lep_kel$inc_1000,lw_lep_inc)
LEPinc_poly <- cbind(inc_lep_kel, Local_Moran_lepinc)
#plot Local Moran
plotMlepinc <- ggplot(data = LEPinc_poly) +
  geom_sf(aes(fill=Ii)) +
  theme_bw() +
  scale_fill_gradient2(low="#2c7bb6", mid="#ffffbf", high="#d7191c",
                       name="Local Moran's I") +
  labs(title="2016-2020")
plot(plotMlepinc)
```


Plot Local Moran for Leptospirosis incidence
- 2020-2021 excluded (not significant)

```{r name-of-chunk29, fig.width=16, fig.height=9}
#| cache = TRUE
grid.arrange(plotMlep16inc, plotMlep17inc, plotMlep18inc, plotMlep19inc, plotMlep22inc, plotMlepinc,  nrow=2, top=textGrob("Local Moran's I Map of Leptospirosis Incidence in Kelantan 2016-2022", gp = gpar(fontsize = 20)))
```


Local Moran's I p-values leptospirosis incidence

```{r}
#| cache = TRUE
LMp16i <- tm_shape(LEP16inc_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2016")+
  tm_borders(alpha = 0.5)

LMp17i <- tm_shape(LEP17inc_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2017")+
  tm_borders(alpha = 0.5)

LMp18i <- tm_shape(LEP18inc_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2018")+
  tm_borders(alpha = 0.5)

LMp19i <- tm_shape(LEP19inc_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2019")+
  tm_borders(alpha = 0.5)

LMp22i <- tm_shape(LEP22inc_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2022")+
  tm_borders(alpha = 0.5)

LMpi <- tm_shape(LEP_poly) +
  tm_fill(col = "Pr.z....E.Ii..",
          breaks=c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
          palette = "-Blues",
          title = "2016-2022")+
  tm_borders(alpha = 0.5)
```

plot Local Moran's I p-values leptospirosis incidence

```{r name-of-chunk30, fig.width=16, fig.height=9}
#| cache = TRUE
# combine all local moran pvalue plot for leptospirosis  in one view
tmap_arrange(LMp16i, LMp17i, LMp18i, LMp19i, LMp22i, LMpi, ncol = 3) 
```


LISA map for leptospirosis incidence

```{r}
#| cache = TRUE
#LISA 2016-2022 leptospirosis incidence
m_lepinc <- inc_lep_kel$inc_1000 - mean(inc_lep_kel$inc_1000) #Center the variable of interest around its mean
m_local_lepinc <- Local_Moran_lepinc[,1]- mean(Local_Moran_lepinc[,1]) #Center the local Moran around the mean
signif <- 0.05 #significant threshold
quadrant_lepinc <- vector(mode="numeric",length = nrow(Local_Moran_lepinc))
#set classification - built data quadrant
quadrant_lep [m_lepinc>0 & m_local_lepinc>0] <- 4
quadrant_lep [m_lepinc<0 & m_local_lepinc<0] <- 1
quadrant_lep [m_lepinc<0 & m_local_lepinc>0] <- 2
quadrant_lep [m_lepinc>0 & m_local_lepinc<0] <- 3
quadrant_lep [Local_Moran_lepinc[,5]] <- 0
#plot LISA
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel[,5],main = "LISA Map of Leptospirosis Incidence 2016-2022", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#LISA 2016leptospirosis incidence
m_lepinc16 <- inc_lep_kel16$inc_1000 - mean(inc_lep_kel16$inc_1000) 
m_local_lepinc16 <- Local_Moran_lep16inc[,1]- mean(Local_Moran_lep16inc[,1]) 
signif <- 0.05 
quadrant_lep16inc <- vector(mode="numeric",length = nrow(Local_Moran_lep16inc))
quadrant_lep [m_lepinc16>0 & m_local_lepinc16>0] <- 4
quadrant_lep [m_lepinc16<0 & m_local_lepinc16<0] <- 1
quadrant_lep [m_lepinc16<0 & m_local_lepinc16>0] <- 2
quadrant_lep [m_lepinc16>0 & m_local_lepinc16<0] <- 3
quadrant_lep [Local_Moran_lep16inc[,5]] <- 0
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel16[,5],main = "LISA Map of Leptospirosis Incidence 2016", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#LISA 2017leptospirosis incidence
m_lepinc17 <- inc_lep_kel17$inc_1000 - mean(inc_lep_kel17$inc_1000) 
m_local_lepinc17 <- Local_Moran_lep17inc[,1]- mean(Local_Moran_lep17inc[,1]) 
signif <- 0.05 
quadrant_lep17inc <- vector(mode="numeric",length = nrow(Local_Moran_lep17inc))
quadrant_lep [m_lepinc17>0 & m_local_lepinc17>0] <- 4
quadrant_lep [m_lepinc17<0 & m_local_lepinc17<0] <- 1
quadrant_lep [m_lepinc17<0 & m_local_lepinc17>0] <- 2
quadrant_lep [m_lepinc17>0 & m_local_lepinc17<0] <- 3
quadrant_lep [Local_Moran_lep17inc[,5]] <- 0
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel17[,5],main = "LISA Map of Leptospirosis Incidence 2017", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#LISA 2018leptospirosis incidence
m_lepinc18 <- inc_lep_kel18$inc_1000 - mean(inc_lep_kel18$inc_1000) 
m_local_lepinc18 <- Local_Moran_lep18inc[,1]- mean(Local_Moran_lep18inc[,1]) 
signif <- 0.05 
quadrant_lep18inc <- vector(mode="numeric",length = nrow(Local_Moran_lep18inc))
quadrant_lep [m_lepinc18>0 & m_local_lepinc18>0] <- 4
quadrant_lep [m_lepinc18<0 & m_local_lepinc18<0] <- 1
quadrant_lep [m_lepinc18<0 & m_local_lepinc18>0] <- 2
quadrant_lep [m_lepinc18>0 & m_local_lepinc18<0] <- 3
quadrant_lep [Local_Moran_lep18inc[,5]] <- 0
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel18[,5],main = "LISA Map of Leptospirosis Incidence 2018", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#LISA 2019leptospirosis incidence
m_lepinc19 <- inc_lep_kel19$inc_1000 - mean(inc_lep_kel19$inc_1000) 
m_local_lepinc19 <- Local_Moran_lep19inc[,1]- mean(Local_Moran_lep19inc[,1]) 
signif <- 0.05 
quadrant_lep19inc <- vector(mode="numeric",length = nrow(Local_Moran_lep19inc))
quadrant_lep [m_lepinc19>0 & m_local_lepinc19>0] <- 4
quadrant_lep [m_lepinc19<0 & m_local_lepinc19<0] <- 1
quadrant_lep [m_lepinc19<0 & m_local_lepinc19>0] <- 2
quadrant_lep [m_lepinc19>0 & m_local_lepinc19<0] <- 3
quadrant_lep [Local_Moran_lep19inc[,5]] <- 0
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel19[,5],main = "LISA Map of Leptospirosis Incidence 2019", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")

#LISA 2022leptospirosis incidence
m_lepinc22 <- inc_lep_kel22$inc_1000 - mean(inc_lep_kel22$inc_1000) 
m_local_lepinc22 <- Local_Moran_lep22inc[,1]- mean(Local_Moran_lep22inc[,1]) 
signif <- 0.05 
quadrant_lep22inc <- vector(mode="numeric",length = nrow(Local_Moran_lep22inc))
quadrant_lep [m_lepinc22>0 & m_local_lepinc22>0] <- 4
quadrant_lep [m_lepinc22<0 & m_local_lepinc22<0] <- 1
quadrant_lep [m_lepinc22<0 & m_local_lepinc22>0] <- 2
quadrant_lep [m_lepinc22>0 & m_local_lepinc22<0] <- 3
quadrant_lep [Local_Moran_lep22inc[,5]] <- 0
brks <- c(0,1,2,3,4)
colors <- c("white", "blue",rgb(0,0,1,alpha=0.4),rgb(1,0,0,alpha = 0.4),"red")
plot(inc_lep_kel22[,5],main = "LISA Map of Leptospirosis Incidence 2022", las = 1, border="lightgray",col=colors[findInterval(quadrant_lep,brks,all.inside = FALSE)])
legend("bottomright",legend = c("insignificant","low-low","low-high","high-low","high-high"),
       fill=colors,bty="n")
```

# corelation between cases abd population density

spatial relation of enteric fever cases to population by Lee's L test
- if not significant, the pattern of cases and population are not related to one another, the spatial pattern of cases is not strictly a result of population density in high-risk areas

```{r}
#| cache = TRUE
# 2016-2022
lee_testent <- lee.test(x=count_ent$n, y=count_ent$AVR, listw=lw_ent)            
lee_testent

# 2016
lee_testent16 <- lee.test(x=count_ent16s$n, y=count_ent16s$JUMLAH_2016, listw=lw_ent16)
lee_testent16

# 2017
lee_testent17 <- lee.test(x=count_ent17s$n, y=count_ent17s$JUMLAH_2017, listw=lw_ent17)     
lee_testent17

# 2018
lee_testent18 <- lee.test(x=count_ent18s$n, y=count_ent18s$JUMLAH_2018, listw=lw_ent18)      
lee_testent18

# 2019
lee_testent19 <- lee.test(x=count_ent19s$n, y=count_ent19s$JUMLAH_2019, listw=lw_ent19)     
lee_testent19

# 2020
lee_testent20 <- lee.test(x=count_ent20s$n, y=count_ent20s$JUMLAH_2020, listw=lw_ent20)     
lee_testent20

# 2021
lee_testent21 <- lee.test(x=count_ent21s$n, y=count_ent21s$JUMLAH_2021, listw=lw_ent21)     
lee_testent21

# 2022
lee_testent22 <- lee.test(x=count_ent22s$n, y=count_ent22s$JUMLAH_2022, listw=lw_ent22)     
lee_testent22

```

spatial relation of leptospirosis cases to population by Lee's L test
- if not significant, the pattern of cases and population are not related to one another, the spatial pattern of cases is not strictly a result of population density in high-risk areas

```{r}
#| cache = TRUE
# 2016-2022
lee_testlep <- lee.test(x=inc_lep_kel$n, y=inc_lep_kel$AVR, listw=lw_lep)            
lee_testlep

# 2016
lee_testlep16 <- lee.test(x=inc_lep_kel16$n, y=inc_lep_kel16$JUMLAH_2016, listw=lw_lep16)
lee_testlep16

# 2017
lee_testlep17 <- lee.test(x=inc_lep_kel17$n, y=inc_lep_kel17$JUMLAH_2017, listw=lw_lep17)
lee_testlep17

# 2018
lee_testlep18 <- lee.test(x=inc_lep_kel18$n, y=inc_lep_kel18$JUMLAH_2018, listw=lw_lep18)
lee_testlep18

# 2019
lee_testlep19 <- lee.test(x=inc_lep_kel19$n, y=inc_lep_kel19$JUMLAH_2019, listw=lw_lep19)
lee_testlep19

# 2020
lee_testlep20 <- lee.test(x=inc_lep_kel20$n, y=inc_lep_kel20$JUMLAH_2020, listw=lw_lep20)
lee_testlep20

# 2021
lee_testlep21 <- lee.test(x=inc_lep_kel21$n, y=inc_lep_kel21$JUMLAH_2021, listw=lw_lep21)
lee_testlep21

# 2022
lee_testlep22 <- lee.test(x=inc_lep_kel22$n, y=inc_lep_kel22$JUMLAH_2022, listw=lw_lep22)
lee_testlep22
```
